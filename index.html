<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monad区块链分析系统</title>
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #4CAF50;
            --error-color: #ff4444;
            --background: #f5f7fa;
        }
        
        /* 优化后的容器布局 */
        .analysis-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* 增强型表格样式 */
        .enhanced-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        .enhanced-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 3px solid #e0e0e0;
            font-weight: 600;
        }
        .enhanced-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .address-link {
            color: var(--primary-color);
            text-decoration: none;
            font-family: monospace;
        }

        /* 加载动画 */
        @keyframes pulse {
            50% { opacity: 0.5; }
        }
        .loading-status {
            animation: pulse 1.5s infinite;
            color: #666;
        }

        /* 控制面板样式 */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        .input-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="analysis-container">
        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="input-group">
                <label>API密钥:</label>
                <input type="text" id="apiKey" placeholder="输入BlockVision API密钥">
            </div>
            <div class="input-group">
                <label>查询线程数:</label>
                <select id="threads">
                    <option value="1">1线程</option>
                    <option value="3" selected>3线程</option>
                    <option value="5">5线程</option>
                    <option value="10">10线程</option>
                </select>
            </div>
            <div class="input-group">
                <label>查询间隔(秒):</label>
                <input type="number" id="interval" value="1" min="0">
            </div>
        </div>

        <!-- 地址输入 -->
        <textarea id="addresses" 
                  placeholder="输入钱包地址（每行一个）"
                  style="width:100%; height:120px; margin-bottom:1.5rem; padding:1rem;"></textarea>

        <!-- 操作按钮 -->
        <button onclick="startAnalysis()" style="width:100%; padding:12px; background:var(--primary-color); color:white; border:none; border-radius:8px;">
            开始分析
        </button>

        <!-- 全局统计 -->
        <div style="margin:2rem 0; padding:1.5rem; background:#f8f9fa; border-radius:8px;">
            <h3>全局统计</h3>
            <div style="display:flex; gap:2rem; margin-top:1rem;">
                <div>
                    <span style="color:#666;">总MON余额:</span>
                    <span id="totalMON" style="font-weight:600;">0.0000</span>
                </div>
                <div>
                    <span style="color:#666;">总aprMON余额:</span>
                    <span id="totalAprMON" style="font-weight:600;">0.0000</span>
                </div>
                <div>
                    <span style="color:#666;">持有灵魂勋章:</span>
                    <span id="totalSoulNFT" style="font-weight:600;">0</span>
                </div>
            </div>
        </div>

        <!-- 分析结果表格 -->
        <table class="enhanced-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>钱包地址</th>
                    <th>MON余额</th>
                    <th>aprMON</th>
                    <th>灵魂勋章</th>
                    <th>交易数</th>
                    <th>活动数</th>
                    <th>内部交易</th>
                    <th>交互合约</th>
                </tr>
            </thead>
            <tbody id="resultBody">
                <!-- 动态加载结果 -->
            </tbody>
        </table>
    </div>

<script>
const API_CONFIG = {
    tokens: 'https://api.blockvision.org/v2/monad/account/tokens',
    nfts: 'https://api.blockvision.org/v2/monad/account/nfts',
    transactions: 'https://api.blockvision.org/v2/monad/account/transactions',
    activities: 'https://api.blockvision.org/v2/monad/account/activities',
    internal: 'https://api.blockvision.org/v2/monad/account/internal/transactions'
};

const CONTRACT_ADDRESSES = {
    MON: '0x0000000000000000000000000000000000000000',
    APRMON: '0xb2f82D0f38dc453D596Ad40A37799446Cc89274A',
    SOUL_NFT: '0x922dA3512e2BEBBe32bccE59adf7E6759fB8CEA2'
};

class AdvancedAnalyzer {
    constructor() {
        this.activeThreads = 0
        this.results = []
        this.totalMON = 0
        this.totalAprMON = 0
        this.totalSoulNFT = 0
    }

    async startAnalysis(addresses, threads, interval) {
        const batchSize = Math.ceil(addresses.length / threads)
        
        for (let i=0; i<threads; i++) {
            this.processBatch(
                addresses.slice(i*batchSize, (i+1)*batchSize),
                interval
            )
        }
    }

    async processBatch(batch, interval) {
        for (const [index, address] of batch.entries()) {
            const result = await this.analyzeAddress(address)
            this.updateResults(result)
            this.renderRow(result, index)
            await new Promise(r => setTimeout(r, interval*1000))
        }
    }

    async analyzeAddress(address) {
        try {
            const [tokens, nfts, txData] = await Promise.all([
                this.fetchPaginated(API_CONFIG.tokens, address, 'tokens'),
                this.fetchPaginated(API_CONFIG.nfts, address, 'nfts'),
                this.fetchContractData(address)
            ])
            
            return {
                address,
                ...this.processTokens(tokens),
                hasSoulNFT: this.checkSoulNFT(nfts),
                ...txData
            }
        } catch (error) {
            console.error(`分析失败: ${address}`, error)
            return this.createErrorResult(address)
        }
    }

    async fetchPaginated(endpoint, address, dataKey) {
        let allData = []
        let cursor = ''
        
        do {
            const url = `${endpoint}?address=${address}&cursor=${cursor}&limit=50`
            const response = await fetch(url)
            const { result } = await response.json()
            
            allData = allData.concat(result[dataKey] || [])
            cursor = result.nextPageCursor || ''
        } while (cursor)
        
        return allData
    }

    processTokens(tokens) {
        return {
            MON: this.findTokenBalance(tokens, CONTRACT_ADDRESSES.MON),
            aprMON: this.findTokenBalance(tokens, CONTRACT_ADDRESSES.APRMON)
        }
    }

    findTokenBalance(tokens, contract) {
        const token = tokens.find(t => 
            t.contractAddress?.toLowerCase() === contract.toLowerCase()
        )
        return token ? Number(token.balance).toFixed(4) : '0.0000'
    }

    checkSoulNFT(nfts) {
        return nfts.some(nft => 
            nft.contractAddress?.toLowerCase() === CONTRACT_ADDRESSES.SOUL_NFT.toLowerCase()
        )
    }

    async fetchContractData(address) {
        const [tx, activities, internal] = await Promise.all([
            this.fetchPaginated(API_CONFIG.transactions, address, 'transactions'),
            this.fetchPaginated(API_CONFIG.activities, address, 'activities'),
            this.fetchPaginated(API_CONFIG.internal, address, 'internalTransactions')
        ])

        const contracts = new Set()
        tx.forEach(t => {
            if(t.to) contracts.add(t.to.toLowerCase())
            if(t.from) contracts.add(t.from.toLowerCase())
        })

        return {
            transactions: tx.length,
            activities: activities.length,
            internal: internal.length,
            contracts: contracts.size
        }
    }

    updateResults(result) {
        this.totalMON += parseFloat(result.MON)
        this.totalAprMON += parseFloat(result.aprMON)
        if(result.hasSoulNFT) this.totalSoulNFT++
        
        document.getElementById('totalMON').textContent = this.totalMON.toFixed(4)
        document.getElementById('totalAprMON').textContent = this.totalAprMON.toFixed(4)
        document.getElementById('totalSoulNFT').textContent = this.totalSoulNFT
    }

    renderRow(data, index) {
        const tbody = document.getElementById('resultBody')
        const row = tbody.insertRow()
        
        row.innerHTML = `
            <td>${index+1}</td>
            <td>
                <a href="https://testnet.monadexplorer.com/address/${data.address}" 
                   target="_blank" 
                   class="address-link">
                    ${data.address.slice(0,6)}...${data.address.slice(-4)}
                </a>
            </td>
            <td>${data.MON}</td>
            <td>${data.aprMON}</td>
            <td>${data.hasSoulNFT ? '✅' : '❌'}</td>
            <td>${data.transactions}</td>
            <td>${data.activities}</td>
            <td>${data.internal}</td>
            <td>${data.contracts}</td>
        `
    }
}

function startAnalysis() {
    const addresses = document.getElementById('addresses').value
        .split('\n')
        .map(a => a.trim())
        .filter(a => a.startsWith('0x') && a.length === 42)
    
    if (!addresses.length) return alert('请输入有效的钱包地址')

    new AdvancedAnalyzer().startAnalysis(
        addresses,
        parseInt(document.getElementById('threads').value),
        parseInt(document.getElementById('interval').value)
    )
}
</script>
</body>
</html>
