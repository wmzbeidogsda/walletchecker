<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monad 批量查询工具 v4.0</title>
    <style>
        /* 保持原有样式不变 */
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .input-group { margin-bottom: 20px; display: grid; gap: 15px; }
        .control-panel { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #e0e0e0; padding: 12px; text-align: left; font-size: 14px; }
        th { background: #f8f9fa; font-weight: 500; }
        tr:nth-child(even) { background-color: #fafafa; }
        a { color: #1890ff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .stats-panel { display: grid; grid-template-columns: repeat(3, max-content); gap: 30px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; }
        .stat-item { display: flex; flex-direction: column; gap: 5px; }
        .stat-label { font-size: 12px; color: #666; }
        .stat-value { font-size: 18px; font-weight: 500; }
        button { padding: 8px 20px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.3s; }
        button:hover { background: #40a9ff; }
        input[type="text"], input[type="number"] { padding: 6px; border: 1px solid #ddd; border-radius: 4px; }
        #apiKey { width: 280px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Monad 批量查询工具 v4.0</h2>
        
        <div class="input-group">
            <textarea id="addresses" placeholder="输入要查询的地址（每行一个）"></textarea>
            
            <div class="control-panel">
                <div>
                    <label>API密钥:</label>
                    <input type="text" id="apiKey" placeholder="x-api-key">
                </div>
                <div>
                    <label>线程数:</label>
                    <input type="number" id="threads" min="1" max="10" value="1">
                </div>
                <div>
                    <label>间隔(秒):</label>
                    <input type="number" id="interval" value="5">
                </div>
                <button onclick="startQuery()">开始查询</button>
            </div>
        </div>

        <div class="stats-panel">
            <div class="stat-item">
                <span class="stat-label">总 MON</span>
                <span class="stat-value" id="totalMON">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">总 aprMON</span>
                <span class="stat-value" id="totalAprMON">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">唯一合约数</span>
                <span class="stat-value" id="uniqueContracts">0</span>
            </div>
        </div>

        <table id="resultTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>地址</th>
                    <th>MON余额</th>
                    <th>aprMON余额</th>
                    <th>交易总数</th>
                    <th>交互合约数</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let results = [];
        let isQueryRunning = false;
        const TOKEN_CONFIG = {
            MON: "0x0000000000000000000000000000000000000000",
            APR_MON: "0xb2f82D0f38dc453D596Ad40A37799446Cc89274A"
        };

        // 地址脱敏处理
        function formatAddress(address) {
            return address ? `${address.slice(0, 6)}...${address.slice(-4)}` : '';
        }

        async function queryAddress(originalAddress, index) {
            const apiKey = document.getElementById('apiKey').value;
            const address = originalAddress.toLowerCase();
            const contracts = new Set();

            try {
                // 查询代币余额
                const tokensRes = await fetchWithRetry(
                    `https://api.blockvision.org/v2/monad/account/tokens?address=${address}`,
                    apiKey
                );
                
                // 查询普通交易
                const txRes = await fetchWithRetry(
                    `https://api.blockvision.org/v2/monad/account/txs?address=${address}`,
                    apiKey
                );

                // 查询内部交易
                const internalTxRes = await fetchWithRetry(
                    `https://api.blockvision.org/v2/monad/account/internal-txs?address=${address}`,
                    apiKey
                );

                // 处理合约地址
                [...txRes?.result?.data, ...internalTxRes?.result?.data].forEach(tx => {
                    if (tx.to) contracts.add(tx.to.toLowerCase());
                    if (tx.from) contracts.add(tx.from.toLowerCase());
                });

                // 处理代币数据
                let monBalance = 0, aprmonBalance = 0;
                tokensRes?.result?.data?.forEach(token => {
                    const addr = token.contractAddress?.toLowerCase();
                    if (addr === TOKEN_CONFIG.MON.toLowerCase()) {
                        monBalance = parseFloat(token.balance);
                    } else if (addr === TOKEN_CONFIG.APR_MON.toLowerCase()) {
                        aprmonBalance = parseFloat(token.balance);
                    }
                });

                return {
                    index,
                    originalAddress,
                    formattedAddress: formatAddress(address),
                    monBalance,
                    aprmonBalance,
                    totalTx: (txRes?.result?.total || 0) + (internalTxRes?.result?.total || 0),
                    contractCount: contracts.size
                };
            } catch (error) {
                console.error(`查询地址 ${address} 失败:`, error);
                return null;
            }
        }

        async function fetchWithRetry(url, apiKey, retries = 3) {
            try {
                const res = await fetch(url, {
                    headers: { 'x-api-key': apiKey }
                });
                
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || `HTTP error! status: ${res.status}`);
                }
                return await res.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return fetchWithRetry(url, apiKey, retries - 1);
                }
                throw error;
            }
        }

        async function startQuery() {
            if (isQueryRunning) {
                alert("已有查询正在进行");
                return;
            }
            
            if (!document.getElementById('apiKey').value) {
                alert("请输入API密钥");
                return;
            }

            isQueryRunning = true;
            results = [];
            document.querySelector('tbody').innerHTML = '';
            
            const addresses = document.getElementById('addresses').value
                .split('\n')
                .map(addr => addr.trim())
                .filter(addr => addr.length === 42);

            const threadCount = parseInt(document.getElementById('threads').value);
            const interval = parseInt(document.getElementById('interval').value) * 1000;

            try {
                for (let i = 0; i < addresses.length; i += threadCount) {
                    const batch = addresses.slice(i, i + threadCount);
                    const promises = batch.map((addr, idx) => 
                        queryAddress(addr, i + idx + 1)
                    );
                    
                    const batchResults = await Promise.all(promises);
                    results.push(...batchResults.filter(Boolean));
                    
                    updateUI();
                    
                    if (i + threadCount < addresses.length) {
                        await new Promise(resolve => setTimeout(resolve, interval));
                    }
                }
            } finally {
                isQueryRunning = false;
            }
        }

        function updateUI() {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = results.map(item => `
                <tr>
                    <td>${item.index}</td>
                    <td>
                        <a href="https://testnet.monadexplorer.com/address/${item.originalAddress}" 
                           target="_blank">${item.formattedAddress}</a>
                    </td>
                    <td>${item.monBalance.toFixed(4)}</td>
                    <td>${item.aprmonBalance.toFixed(4)}</td>
                    <td>${item.totalTx}</td>
                    <td>${item.contractCount}</td>
                </tr>
            `).join('');

            // 更新统计
            const totalMON = results.reduce((sum, item) => sum + item.monBalance, 0);
            const totalAprMON = results.reduce((sum, item) => sum + item.aprmonBalance, 0);
            const uniqueContracts = new Set(results.flatMap(item => item.contractAddresses)).size;
            
            document.getElementById('totalMON').textContent = totalMON.toFixed(4);
            document.getElementById('totalAprMON').textContent = totalAprMON.toFixed(4);
            document.getElementById('uniqueContracts').textContent = uniqueContracts;
        }
    </script>
</body>
</html>
