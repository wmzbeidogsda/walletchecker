<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monad 批量查询工具 v7.0</title>
    <style>
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .control-panel {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 12px;
            text-align: left;
            font-size: 14px;
        }
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(2, max-content);
            gap: 30px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        button {
            padding: 8px 20px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #apiKey { width: 280px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Monad 批量查询工具 v7.0</h2>
        
        <div class="input-group">
            <textarea id="addresses" placeholder="输入要查询的地址（每行一个）"></textarea>
            
            <div class="control-panel">
                <div>
                    <label>API密钥:</label>
                    <input type="text" id="apiKey" placeholder="x-api-key">
                </div>
                <div>
                    <label>线程数:</label>
                    <input type="number" id="threads" min="1" max="10" value="1">
                </div>
                <div>
                    <label>间隔(秒):</label>
                    <input type="number" id="interval" value="5">
                </div>
                <button onclick="startQuery()">开始查询</button>
            </div>
        </div>

        <div class="stats-panel">
            <div class="stat-item">
                <span class="stat-label">总 MON</span>
                <span class="stat-value" id="totalMON">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">总 aprMON</span>
                <span class="stat-value" id="totalAprMON">0</span>
            </div>
        </div>

        <table id="resultTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>地址</th>
                    <th>MON余额</th>
                    <th>aprMON余额</th>
                    <th>交易总数</th>
                    <th>交互合约数</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const API_ENDPOINTS = {
            TOKENS: 'https://api.blockvision.org/v2/monad/account/tokens',
            TRANSACTIONS: 'https://api.blockvision.org/v2/monad/account/transactions',
            INTERNAL_TX: 'https://api.blockvision.org/v2/monad/account/internal/transactions'
        };

        function formatAddress(address) {
            return address ? `${address.slice(0, 6)}...${address.slice(-4)}` : '';
        }

        async function queryAddress(address, index) {
            try {
                const [tokensRes, txRes, internalTxRes] = await Promise.all([
                    fetchData(`${API_ENDPOINTS.TOKENS}?address=${address}`, document.getElementById('apiKey').value),
                    fetchData(`${API_ENDPOINTS.TRANSACTIONS}?address=${address}`, document.getElementById('apiKey').value),
                    fetchData(`${API_ENDPOINTS.INTERNAL_TX}?address=${address}`, document.getElementById('apiKey').value)
                ]);

                const contracts = new Set();
                [...txRes.result.data, ...internalTxRes.result.data].forEach(tx => {
                    if (tx.to) contracts.add(tx.to.toLowerCase());
                    if (tx.from) contracts.add(tx.from.toLowerCase());
                });

                return {
                    index,
                    originalAddress: address,
                    formattedAddress: formatAddress(address),
                    monBalance: parseTokenBalance(tokensRes, 'MON'),
                    aprmonBalance: parseTokenBalance(tokensRes, 'APR_MON'),
                    totalTx: txRes.result.total + internalTxRes.result.total,
                    contractCount: contracts.size
                };
            } catch (error) {
                console.error(`查询失败: ${error}`);
                return null;
            }
        }

        function parseTokenBalance(response, tokenType) {
            const token = response.result.data.find(t => 
                t.contractAddress?.toLowerCase() === TOKEN_CONFIG[tokenType].toLowerCase()
            );
            return parseFloat(token?.balance || 0);
        }

        async function fetchData(url, apiKey, retries = 3) {
            try {
                const res = await fetch(url, {
                    headers: { 'x-api-key': apiKey }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return fetchData(url, apiKey, retries - 1);
                }
                throw error;
            }
        }

        // 其他函数保持不变...
    </script>
</body>
</html>
