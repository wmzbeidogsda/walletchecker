<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monadå¤šåŠŸèƒ½ç®¡ç†</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --danger-color: #ff4d4f;
            --success-color: #52c41a;
            --background-color: #f5f7fa;
            --card-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --sidebar-width: 250px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            background-color: var(--background-color);
            color: #333;
            display: flex;
            min-height: 100vh;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            color: white;
            padding: 1rem 0;
            height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 1rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }

        .sidebar-menu {
            list-style: none;
        }

        .menu-item {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .menu-item.active {
            background-color: var(--primary-color);
        }

        .menu-item i {
            margin-right: 10px;
        }

        .submenu {
            list-style: none;
            padding-left: 1.5rem;
            display: none;
        }

        .submenu.show {
            display: block;
        }

        .submenu-item {
            padding: 0.6rem 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .submenu-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .submenu-item.active {
            color: var(--primary-color);
        }

        /* ä¸»å†…å®¹åŒºæ ·å¼ */
        .main-content {
            flex: 1;
            padding: 2rem;
            transition: margin-left 0.3s;
        }

        /* æ¬¢è¿é¡µé¢æ ·å¼ */
        .welcome-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80vh;
            text-align: center;
        }

        .welcome-message {
            font-size: 2.5rem;
            color: var(--primary-color);
            font-weight: 300;
            animation: fadeIn 1.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Monadäº¤äº’é¡¹ç›®ç®¡ç†æ ·å¼ */
        .monad-project-container {
            display: none;
        }

        .monad-project-container.show {
            display: block;
        }

        .stats-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
           justify-content: flex-start; 
        }

.task-button {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: transform 0.1s, background 0.3s;
    width: 310px;  /* å›ºå®šå®½åº¦ */
    text-align: center;  /* æ–‡å­—å±…ä¸­ */
    display: inline-block;  /* æ”¹ä¸ºè¡Œå†…å—å…ƒç´  */
    margin: 5px;  /* æ·»åŠ ä¸€äº›å¤–è¾¹è· */
}

        .task-button.danger {
            background: var(--danger-color);
        }

        .task-button.success {
            background: var(--success-color);
        }

        .project-list {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .project-item {
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
            position: relative;
        }

        .project-item.unopened {
            background: #f8f9fa;
            border: 2px solid var(--primary-color);
        }

        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .unopened-badge {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .batch-input {
            width: 100%;
            height: 150px;
            margin: 1rem 0;
            padding: 1rem;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .select-all-checkbox {
            margin-left: 10px;
            transform: scale(1.2);
        }

        .project-checkbox {
            position: absolute;
            left: 15px;
            transform: scale(1.2);
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #openQuantity {
            width: 60px;
            padding: 8px;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            font-size: 14px;
        }

.compact-button {
    padding: 12px 24px; 
    width: 200px; 
    margin: 5px; 
}

        /* Monadé’±åŒ…æŸ¥è¯¢æ ·å¼ */
        .monad-wallet-container {
            display: none;
        }

        .monad-wallet-container.show {
            display: block;
            margin-top: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 2rem;
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-size: 0.9rem;
            color: #666;
        }

        input, select, button {
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        button {
            background: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        button:hover {
            opacity: 0.9;
        }

        #addresses {
            width: 100%;
            height: 120px;
            margin: 1rem 0;
            padding: 1rem;
            font-family: monospace;
        }

        .stats-bar {
            display: flex;
            gap: 2rem;
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .address-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        .address-table th,
        .address-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .address-table th {
            background: #f8f9fa;
            color: #666;
            font-weight: 500;
        }

        .address-short a {
            font-family: monospace;
            color: #2196F3;
            text-decoration: none;
        }

        .address-short a:hover {
            text-decoration: underline;
        }

        .numeric {
            font-family: monospace;
            color: #333;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading-status {
            animation: pulse 1.5s infinite;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹å¯¼èˆªæ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Monadç®¡ç†</h2>
        </div>
        <ul class="sidebar-menu">
            <li class="menu-item" id="dashboard-menu">
                <i>ğŸ </i> æ§åˆ¶é¢æ¿
            </li>
            <li class="menu-item" id="function-menu">
                <i>âš™ï¸</i> åŠŸèƒ½ç®¡ç†
            </li>
            <ul class="submenu" id="function-submenu">
                <li class="submenu-item" data-target="project">äº¤äº’ç®¡ç†</li>
                <li class="submenu-item" data-target="wallet">é’±åŒ…æŸ¥è¯¢</li>
            </ul>
        </ul>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <!-- æ¬¢è¿é¡µé¢ -->
        <div class="welcome-container" id="welcome-page">
            <div class="welcome-message">
                äºŒåå²å·çš„æ‡’ï¼Œä¸‰åå²æ—¥å¤œå¼¥è¡¥
            </div>
        </div>

        <!-- Monadäº¤äº’é¡¹ç›®ç®¡ç† -->
        <div class="monad-project-container" id="project-container">
            <div class="container">
                <div class="stats-card">
                    <h2>é¡¹ç›®ç»Ÿè®¡</h2>
                    <p>å·²æ‰“å¼€ï¼š<span id="openedCount">0</span></p>
                    <p>æœªæ‰“å¼€ï¼š<span id="unopenedCount">0</span></p>
                    
                    <h3 style="margin-top:1.5rem;">æ‰¹é‡æ·»åŠ é¡¹ç›®</h3>
                    <textarea class="batch-input" id="batchInput" placeholder="æ‰¹é‡å¯¼å…¥é¡¹ç›®ç½‘å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰&#10;ç¤ºä¾‹ï¼š&#10;https://www.kuru.io/swap&#10;https://monad.curvance.com/monad"></textarea>
                    
                    <div class="button-group">
                        <button class="task-button success" onclick="batchAddProjects()">æ‰¹é‡å¯¼å…¥é¡¹ç›®</button>
                        <div class="quantity-control">
                            <button class="task-button primary" onclick="openRandomProjects()">éšæœºæ‰“å¼€ä»»åŠ¡</button>
                        </div>
                        <button class="task-button danger" onclick="clearProgress()">é‡ç½®å·²æ‰“å¼€</button>
                    </div>

                    <div class="checkbox-group" style="margin-top:1.5rem;">
                        <input type="checkbox" id="selectAll" class="select-all-checkbox" onchange="toggleSelectAll(this.checked)">
                        <label for="selectAll">å…¨é€‰</label>
                        <button class="task-button danger compact-button" onclick="batchDelete()">æ‰¹é‡åˆ é™¤</button>
                                                <label>è‡ªå®šä¹‰æ‰“å¼€æ•°é‡:</label>
                         <input type="number" id="openQuantity" min="1" value="1" title="æ¯æ¬¡æ‰“å¼€æ•°é‡">

                    </div>
                </div>

                <div class="project-list">
                    <h3>é¡¹ç›®åˆ—è¡¨</h3>
                    <div id="projectList"></div>
                </div>
            </div>
        </div>

        <!-- Monadé’±åŒ…æŸ¥è¯¢ -->
        <div class="monad-wallet-container" id="wallet-container">
            <div class="container">
                <div class="control-panel">
                    <div class="input-group">
                        <label>APIå¯†é’¥:</label>
                        <input type="text" id="apiKey" placeholder="è¾“å…¥APIå¯†é’¥">
                    </div>
                    <div class="input-group">
                        <label>æŸ¥è¯¢çº¿ç¨‹æ•°:</label>
                        <select id="threads">
                            <option value="1" selected>1çº¿ç¨‹</option>
                            <option value="2">2çº¿ç¨‹</option>
                            <option value="3">3çº¿ç¨‹</option>
                            <option value="4">4çº¿ç¨‹</option>
                            <option value="5">5çº¿ç¨‹</option>
                            <option value="6">6çº¿ç¨‹</option>
                            <option value="7">7çº¿ç¨‹</option>
                            <option value="8">8çº¿ç¨‹</option>
                            <option value="9">9çº¿ç¨‹</option>
                            <option value="10">10çº¿ç¨‹</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>çº¿ç¨‹é—´éš”(æ¯«ç§’):</label>
                        <input type="number" id="interval" value="1000" min="500">
                    </div>
                </div>

                <textarea id="addresses" placeholder="è¾“å…¥é’±åŒ…åœ°å€ï¼Œæ¯è¡Œä¸€ä¸ª"></textarea>

                <button onclick="startAnalysis()" style="width: 100%">å¼€å§‹æŸ¥è¯¢</button>

                <div class="stats-bar" id="globalStats">
                    <div class="stat-item">
                        <span class="stat-label">æ€» MON:</span>
                        <span class="stat-value" id="totalMON">0.0000</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">æ€»è´¨æŠ¼aprMON:</span>
                        <span class="stat-value" id="totalAprMON">0.0000</span>
                    </div>
                </div>

                <table class="address-table">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>åœ°å€</th>
                            <th>MONä½™é¢</th>
                            <th>aprMONä½™é¢</th>
                            <th>Transaction</th>
                            <th>Activity</th>
                            <th>Internal Transaction</th>
                            <th>æ˜¯å¦æŒæœ‰çµé­‚å‹‹ç« </th>
                            <th>äº¤äº’åˆçº¦æ•°é‡</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å¯¼èˆªåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const dashboardMenu = document.getElementById('dashboard-menu');
            const functionMenu = document.getElementById('function-menu');
            const functionSubmenu = document.getElementById('function-submenu');
            const welcomePage = document.getElementById('welcome-page');
            const walletContainer = document.getElementById('wallet-container');
            const projectContainer = document.getElementById('project-container');
            const submenuItems = document.querySelectorAll('.submenu-item');

            // æ§åˆ¶é¢æ¿ç‚¹å‡»äº‹ä»¶
            dashboardMenu.addEventListener('click', function() {
                welcomePage.style.display = 'flex';
                walletContainer.classList.remove('show');
                projectContainer.classList.remove('show');
                functionSubmenu.classList.remove('show');
                document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                this.classList.add('active');
            });

            // åŠŸèƒ½ç®¡ç†ç‚¹å‡»äº‹ä»¶
            functionMenu.addEventListener('click', function() {
                functionSubmenu.classList.toggle('show');
                this.classList.toggle('active');
            });

            // å­èœå•ç‚¹å‡»äº‹ä»¶
            submenuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    
                    // éšè—æ‰€æœ‰å†…å®¹
                    welcomePage.style.display = 'none';
                    walletContainer.classList.remove('show');
                    projectContainer.classList.remove('show');
                    
                    // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹
                    if (target === 'wallet') {
                        walletContainer.classList.add('show');
                    } else if (target === 'project') {
                        projectContainer.classList.add('show');
                    }
                    
                    // æ›´æ–°èœå•æ¿€æ´»çŠ¶æ€
                    document.querySelectorAll('.submenu-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // é»˜è®¤æ˜¾ç¤ºæ¬¢è¿é¡µé¢
            dashboardMenu.click();
        });

        // Monadäº¤äº’é¡¹ç›®ç®¡ç†åŠŸèƒ½
        let projects = JSON.parse(localStorage.getItem('projects')) || [];
        let openedProjects = JSON.parse(localStorage.getItem('openedProjects')) || [];
        let selectedProjects = new Set();

        function generateProjectName(url) {
            try {
                const urlObj = new URL(url);
                let hostname = urlObj.hostname.replace(/^www\./, '');
                let path = urlObj.pathname.replace(/^\//, '').split('/')[0];
                
                const nameParts = [
                    hostname.split('.')[0],
                    path.replace(/[^a-zA-Z0-9]/g, ' ')
                ].filter(Boolean);

                return nameParts.map(part => 
                    part.replace(/(^\w|\s\w)/g, m => m.toUpperCase())
                ).join(' ');
            } catch {
                return url.replace(/^https?:\/\//, '').split('/')[0];
            }
        }

        function openRandomProjects() {
            const quantity = parseInt(document.getElementById('openQuantity').value) || 1;
            
            if (projects.length === 0) {
                alert('è¯·å…ˆå¯¼å…¥é¡¹ç›®ï¼');
                return;
            }
            
            const unopened = projects.filter(p => !openedProjects.includes(p.url));
            if (unopened.length === 0) {
                alert('æ‰€æœ‰é¡¹ç›®å·²å®Œæˆï¼');
                return;
            }

            const maxQuantity = Math.min(quantity, unopened.length);
            if (maxQuantity < quantity) {
                alert(`æœªå®Œæˆé¡¹ç›®ä¸è¶³ï¼Œæœ¬æ¬¡å°†æ‰“å¼€${maxQuantity}ä¸ª`);
            }

            const shuffled = unopened.sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, maxQuantity);

            selected.forEach(project => {
                openedProjects.push(project.url);
                window.open(project.url, '_blank');
            });

            localStorage.setItem('openedProjects', JSON.stringify(openedProjects));
            updateStats();
        }

        function toggleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.project-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
                handleProjectSelect(checkbox);
            });
        }

        function handleProjectSelect(checkbox) {
            const url = checkbox.dataset.url;
            checkbox.checked ? selectedProjects.add(url) : selectedProjects.delete(url);
            updateSelectAllState();
        }

        function updateSelectAllState() {
            document.getElementById('selectAll').checked = 
                projects.length > 0 && selectedProjects.size === projects.length;
        }

        function batchDelete() {
            if (selectedProjects.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®ï¼');
                return;
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedProjects.size} ä¸ªé¡¹ç›®å—ï¼Ÿ`)) {
                projects = projects.filter(p => !selectedProjects.has(p.url));
                openedProjects = openedProjects.filter(url => !selectedProjects.has(url));
                
                localStorage.setItem('projects', JSON.stringify(projects));
                localStorage.setItem('openedProjects', JSON.stringify(openedProjects));
                
                selectedProjects.clear();
                updateStats();
                alert('åˆ é™¤æˆåŠŸï¼');
            }
        }

        function batchAddProjects() {
            const input = document.getElementById('batchInput').value;
            const newProjects = input.split('\n')
                .map(line => line.trim())
                .filter(line => line)
                .map(url => {
                    if (!url.startsWith('http')) url = `https://${url}`;
                    return { name: generateProjectName(url), url: url };
                });

            const existingUrls = new Set(projects.map(p => p.url));
            const uniqueProjects = newProjects.filter(p => 
                !existingUrls.has(p.url) && /^https?:\/\//.test(p.url));
            
            projects = [...projects, ...uniqueProjects];
            localStorage.setItem('projects', JSON.stringify(projects));
            updateStats();
            alert(`æˆåŠŸå¯¼å…¥ ${uniqueProjects.length} ä¸ªæ–°é¡¹ç›®ï¼`);
        }

        function clearProgress() {
            if (confirm("è¾¾è¾¾æé†’:æ¸…ç©ºè¿›åº¦åä¸å¯æ¢å¤å“¦")) {
                openedProjects = [];
                localStorage.setItem('openedProjects', JSON.stringify(openedProjects));
                updateStats();
                alert("è¿›åº¦å·²é‡ç½®");
            }
        }

        function updateStats() {
            document.getElementById('openedCount').textContent = openedProjects.length;
            document.getElementById('unopenedCount').textContent = projects.length - openedProjects.length;
            renderProjectList();
        }

        function renderProjectList() {
            const container = document.getElementById('projectList');
            container.innerHTML = projects.map(project => `
                <div class="project-item ${!openedProjects.includes(project.url) ? 'unopened' : ''}">
                    <input 
                        type="checkbox" 
                        class="project-checkbox"
                        data-url="${project.url}"
                        onchange="handleProjectSelect(this)"
                        ${selectedProjects.has(project.url) ? 'checked' : ''}
                    >
                    <div style="margin-left: 30px;">
                        <span class="status-dot" style="background:${openedProjects.includes(project.url) ? '#ccc' : 'var(--primary-color)'}"></span>
                        ${project.name}
                    </div>
                    ${!openedProjects.includes(project.url) ? 
                        '<span class="unopened-badge">æœªå®Œæˆ</span>' : 
                        '<span style="color: #666">å·²å®Œæˆ</span>'}
                </div>
            `).join('');
            updateSelectAllState();
        }

        // åˆå§‹åŒ–æ—§æ•°æ®è¿ç§»
        if (localStorage.getItem('legacyProjects')) {
            const legacyData = `
                https://www.kuru.io/swap
                https://monad.curvance.com/monad
                https://bebop.xyz/
                https://swap.bean.exchange/
                https://monad.flap.sh/board
                https://testnet.fukunad.xyz/
                https://alpha.izumi.finance/trade/swap
                https://app.hashflow.com/
                https://kintsu.xyz/staking
                https://www.magmastaking.xyz/
                https://testnet-preview.monorail.xyz/
                https://testapp.nitrofinance.xyz/trade
                https://nfts2me.com/create/edition/
                https://testnet.multipli.fi/
                https://testnet.mudigital.net/
                https://monad.nostra.finance/lend-borrow
                https://octo.exchange/swap
                https://pancakeswap.finance/?chain=monadTestnet
                https://redbrick.land/web3-portal?tab=monad_testnet
                https://www.monad.sky.trade/
                https://app.timeswap.io/markets?chainId=10143
                https://app.zona.finance/trade
                https://testnet.monad.xyz/
                https://www.kuru.io/markets
                https://www.shmonad.xyz/
                https://app.uniswap.org/swap?chain=monad
                https://bebop.xyz/trade?network=monad&sell=MON&buy=WMON
                https://testnet.narwhal.finance/slots
                https://dex.dirol.network/swap
                https://monad.ambient.finance/
                https://alpha.clober.io/trade?chain=10143
                https://app.crystal.exchange/swap
                https://alpha-testnet.xlmeme.com/monad
                https://stake.apr.io/
            `;
            
            const legacyProjects = legacyData.split('\n')
                .map(line => line.trim())
                .filter(line => line)
                .map(url => ({ name: generateProjectName(url), url: url }));
            
            projects = [...legacyProjects, ...projects];
            localStorage.removeItem('legacyProjects');
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        // åˆå§‹åŒ–
        updateStats();

        // Monadé’±åŒ…æŸ¥è¯¢åŠŸèƒ½
        const API_CONFIG = {
            tokens: 'https://api.blockvision.org/v2/monad/account/tokens',
            transactions: 'https://api.blockvision.org/v2/monad/account/transactions',
            activities: 'https://api.blockvision.org/v2/monad/account/activities',
            internal: 'https://api.blockvision.org/v2/monad/account/internal/transactions',
            nfts: 'https://api.blockvision.org/v2/monad/account/nfts'
        };

        const APR_MON_CONTRACT = '0xb2f82d0f38dc453d596ad40a37799446cc89274a'.toLowerCase();
        const MON_CONTRACT = '0x0000000000000000000000000000000000000000'.toLowerCase();
        const SOUL_NFT_CONTRACT = '0x922da3512e2bbebbe32bcce59adf7e6759fb8cea2'.toLowerCase();

        class AddressAnalyzer {
            constructor() {
                this.jobQueue = [];
                this.currentIndex = 0;
                this.results = [];
                this.total = 0;
                this.interval = 1000;
                this.threads = 1;
            }

            init(apiKey, addresses, threads, interval) {
                this.apiKey = apiKey;
                this.threads = threads;
                this.interval = interval;
                this.currentIndex = 0;
                this.results = new Array(addresses.length);
                this.jobQueue = addresses;
                this.total = addresses.length;
            }

            async start() {
                const workers = Array.from({ length: this.threads }, () => this.processQueue());
                await Promise.all(workers);
            }

            async processQueue() {
                while (this.currentIndex < this.total) {
                    const index = this.currentIndex++;
                    const address = this.jobQueue[index];
                    
                    const row = this.insertLoadingRow(index, address);
                    
                    try {
                        const result = await this.analyzeAddress(address);
                        this.updateResultRow(row, result);
                        this.results[index] = result;
                    } catch (error) {
                        this.showErrorRow(row);
                        this.results[index] = this.createErrorResult(address);
                    }
                    
                    this.updateGlobalStats();
                    
                    // çº¿ç¨‹é—´éš”æ§åˆ¶
                    if (this.currentIndex % this.threads === 0) {
                        await new Promise(r => setTimeout(r, this.interval));
                    }
                }
            }

            insertLoadingRow(index, address) {
                const row = document.getElementById('resultBody').insertRow(index);
                row.innerHTML = `
                    <td class="numeric">${index + 1}</td>
                    <td class="address-short">
                        <a href="https://testnet.monadexplorer.com/address/${address}" target="_blank">
                            ${this.shortenAddress(address)}
                        </a>
                    </td>
                    <td class="numeric loading-status">...</td>
                    <td class="numeric loading-status">...</td>
                    <td class="numeric loading-status">...</td>
                    <td class="numeric loading-status">...</td>
                    <td class="numeric loading-status">...</td>
                    <td class="numeric loading-status">...</td>
                    <td class="numeric loading-status">...</td>
                `;
                return row;
            }

            updateResultRow(row, result) {
                row.cells[2].textContent = result.MON;
                row.cells[3].textContent = result.aprMON;
                row.cells[4].textContent = result.transactions;
                row.cells[5].textContent = result.activities;
                row.cells[6].textContent = result.internal;
                row.cells[7].textContent = result.hasSoulNFT ? 'æ˜¯' : 'å¦';
                row.cells[8].textContent = result.contracts;
                Array.from(row.cells).forEach(c => c.classList.remove('loading-status'));
            }

            showErrorRow(row) {
                row.innerHTML = '<td colspan="9" style="color: #ff4444">è¯·æ±‚å¤±è´¥</td>';
            }

            createErrorResult(address) {
                return {
                    address,
                    MON: '0.0000',
                    aprMON: '0.0000',
                    transactions: 0,
                    activities: 0,
                    internal: 0,
                    hasSoulNFT: false,
                    contracts: 0
                };
            }

            updateGlobalStats() {
                const validResults = this.results.filter(r => r);
                const totalMON = validResults.reduce((s, r) => s + parseFloat(r.MON), 0);
                const totalAprMON = validResults.reduce((s, r) => s + parseFloat(r.aprMON), 0);
                document.getElementById('totalMON').textContent = totalMON.toFixed(4);
                document.getElementById('totalAprMON').textContent = totalAprMON.toFixed(4);
            }

            shortenAddress(address) {
                return address ? `${address.slice(0,6)}...${address.slice(-4)}` : '';
            }

            async analyzeAddress(address) {
                try {
                    const [tokens, txData, hasSoulNFT] = await Promise.all([
                        this.fetchAllTokens(address),
                        this.fetchContractsData(address),
                        this.checkSoulNFT(address)
                    ]);
                    return this.processData(address, tokens, txData, hasSoulNFT);
                } catch (error) {
                    console.error('æŸ¥è¯¢å¤±è´¥:', error);
                    throw error;
                }
            }

            async fetchAllTokens(address) {
                let allTokens = [];
                let cursor = '';
                let hasNextPage = true;

                while (hasNextPage) {
                    const url = `${API_CONFIG.tokens}?address=${address}&cursor=${cursor}&limit=50`;
                    const data = await this.fetchWithRetry(url);
                    
                    if (data?.result?.data) {
                        allTokens = allTokens.concat(data.result.data);
                    }
                    
                    cursor = data?.result?.nextPageCursor || '';
                    hasNextPage = !!cursor;
                }
                return allTokens;
            }

async checkSoulNFT(address) {
    let hasSoulNFT = false;
    let cursor = '';
    let hasNextPage = true;

    while (hasNextPage && !hasSoulNFT) {
        const url = `${API_CONFIG.nfts}?address=${address}&cursor=${cursor}&limit=50`;
        const data = await this.fetchWithRetry(url);
        
        if (data?.data) {  // æ³¨æ„è¿™é‡Œæ”¹ä¸ºæ£€æŸ¥dataå­—æ®µè€Œä¸æ˜¯result.data
            // æ£€æŸ¥æ¯ä¸ªNFTé›†åˆ
            hasSoulNFT = data.data.some(nftCollection => {
                // æ£€æŸ¥é›†åˆåˆçº¦åœ°å€
                if (nftCollection.contractAddress?.toLowerCase() === SOUL_NFT_CONTRACT) {
                    return true;
                }
                // æ£€æŸ¥itemsæ•°ç»„ä¸­çš„åˆçº¦åœ°å€
                if (nftCollection.items && Array.isArray(nftCollection.items)) {
                    return nftCollection.items.some(item => 
                        item.contractAddress?.toLowerCase() === SOUL_NFT_CONTRACT
                    );
                }
                return false;
            });
        }
        
        cursor = data?.cursor || '';  // æ³¨æ„è¿™é‡Œæ”¹ä¸ºè·å–cursorå­—æ®µ
        hasNextPage = !!cursor;
    }
    return hasSoulNFT;
}

            async fetchContractsData(address) {
                let contracts = new Set();
                let totalTx = 0;
                let cursor = '';

                // è·å–äº¤æ˜“æ€»æ•°
                const firstPage = await this.fetchWithRetry(
                    `${API_CONFIG.transactions}?address=${address}&limit=1`
                );
                totalTx = firstPage.result?.total || 0;

                // è·å–æ‰€æœ‰äº¤æ˜“å’Œåˆçº¦
                while (true) {
                    const data = await this.fetchWithRetry(
                        `${API_CONFIG.transactions}?address=${address}&cursor=${cursor}&limit=50`
                    );
                    
                    if (!data?.result?.data) break;
                    
                    data.result.data.forEach(tx => {
                        tx.toAddress?.isContract && contracts.add(tx.toAddress.address.toLowerCase());
                        tx.contractAddress && contracts.add(tx.contractAddress.toLowerCase());
                    });

                    cursor = data.result.nextPageCursor;
                    if (!cursor) break;
                }

                // è·å–activitiesæ€»æ•°
                const activities = await this.fetchWithRetry(
                    `${API_CONFIG.activities}?address=${address}&limit=1`
                );
                const totalActivities = activities.result?.total || 0;

                // è·å–internal transactionsæ€»æ•°
                const internal = await this.fetchWithRetry(
                    `${API_CONFIG.internal}?address=${address}&limit=1`
                );
                const totalInternal = internal.result?.total || 0;

                return {
                    total: totalTx,
                    contracts: contracts.size,
                    activities: totalActivities,
                    internal: totalInternal
                };
            }

            processData(address, tokens, txData, hasSoulNFT) {
                const MON = tokens.find(t => 
                    t.contractAddress?.toLowerCase() === MON_CONTRACT
                )?.balance || '0';

                const aprMON = tokens.find(t => 
                    t.contractAddress?.toLowerCase() === APR_MON_CONTRACT
                )?.balance || '0';

                return {
                    address,
                    MON: Number(MON).toFixed(4),
                    aprMON: Number(aprMON).toFixed(4),
                    transactions: txData.total,
                    activities: txData.activities,
                    internal: txData.internal,
                    hasSoulNFT,
                    contracts: txData.contracts
                };
            }

            async fetchWithRetry(url, retries = 3) {
                try {
                    const response = await fetch(url, {
                        headers: { 'x-api-key': this.apiKey }
                    });
                    if (!response.ok) throw new Error(`HTTPé”™è¯¯ ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(r => setTimeout(r, 1000));
                        return this.fetchWithRetry(url, retries - 1);
                    }
                    throw error;
                }
            }
        }

        async function startAnalysis() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const addresses = document.getElementById('addresses').value
                .split('\n')
                .map(a => a.trim())
                .filter(a => a.startsWith('0x') && a.length === 42);

            if (!apiKey) return alert('è¯·è¾“å…¥APIå¯†é’¥');
            if (!addresses.length) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é’±åŒ…åœ°å€');

            document.getElementById('resultBody').innerHTML = '';
            document.getElementById('totalMON').textContent = '0.0000';
            document.getElementById('totalAprMON').textContent = '0.0000';

            const analyzer = new AddressAnalyzer();
            analyzer.init(
                apiKey,
                addresses,
                parseInt(document.getElementById('threads').value),
                parseInt(document.getElementById('interval').value)
            );

            try {
                await analyzer.start();
            } catch (error) {
                console.error('æŸ¥è¯¢æµç¨‹å¤±è´¥:', error);
            }
        }
    </script>
</body>
</html>
