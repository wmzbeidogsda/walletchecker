<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monadå¤šåŠŸèƒ½ç®¡ç†</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --danger-color: #ff4d4f;
            --success-color: #52c41a;
            --background-color: #f5f7fa;
            --card-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --sidebar-width: 250px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            background-color: var(--background-color);
            color: #333;
            display: flex;
            min-height: 100vh;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            color: white;
            padding: 1rem 0;
            height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
        }

        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜... */

        /* Monadé’±åŒ…æŸ¥è¯¢æ›´æ–°æ ·å¼ */
        .monad-wallet-container .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .monad-wallet-container .stat-item {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹å¯¼èˆªæ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Monadç®¡ç†</h2>
        </div>
        <ul class="sidebar-menu">
            <li class="menu-item" id="dashboard-menu"><i>ğŸ </i> æ§åˆ¶é¢æ¿</li>
            <li class="menu-item" id="function-menu"><i>âš™ï¸</i> åŠŸèƒ½ç®¡ç†</li>
            <ul class="submenu" id="function-submenu">
                <li class="submenu-item" data-target="project">äº¤äº’ç®¡ç†</li>
                <li class="submenu-item" data-target="wallet">é’±åŒ…æŸ¥è¯¢</li>
            </ul>
        </ul>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <!-- æ¬¢è¿é¡µé¢ -->
        <div class="welcome-container" id="welcome-page">
            <div class="welcome-message">äºŒåå²å·çš„æ‡’ï¼Œä¸‰åå²æ—¥å¤œå¼¥è¡¥</div>
        </div>

        <!-- äº¤äº’ç®¡ç†æ¨¡å—ï¼ˆä¿æŒä¸å˜ï¼‰ -->
        <div class="monad-project-container" id="project-container">
            <!-- ä¿æŒåŸæœ‰äº¤äº’ç®¡ç†UIä¸å˜... -->
        </div>

        <!-- æ›´æ–°åçš„é’±åŒ…æŸ¥è¯¢æ¨¡å— -->
        <div class="monad-wallet-container" id="wallet-container">
            <div class="container">
                <div class="control-panel">
                    <div class="input-group">
                        <label>APIå¯†é’¥:</label>
                        <input type="text" id="apiKey" placeholder="è¾“å…¥APIå¯†é’¥">
                    </div>
                    <div class="input-group">
                        <label>æŸ¥è¯¢çº¿ç¨‹æ•° (1-10):</label>
                        <input type="number" id="threads" min="1" max="10" value="1">
                    </div>
                    <div class="input-group">
                        <label>é—´éš”æ—¶é—´(ç§’):</label>
                        <input type="number" id="interval" value="5" min="1">
                    </div>
                </div>

                <textarea id="addresses" placeholder="è¾“å…¥é’±åŒ…åœ°å€ï¼Œæ¯è¡Œä¸€ä¸ª"></textarea>

                <button onclick="startAnalysis()" style="width:100%;padding:12px">å¼€å§‹æŸ¥è¯¢</button>

                <div class="stats-bar" id="globalStats">
                    <div class="stat-item">
                        <span>æ€» MON:</span>
                        <span id="totalMON">0.0000</span>
                    </div>
                    <div class="stat-item">
                        <span>æ€» aprMON:</span>
                        <span id="totalAprMON">0.0000</span>
                    </div>
                </div>

                <table class="address-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>åœ°å€</th>
                            <th>MON</th>
                            <th>aprMON</th>
                            <th>äº¤æ˜“æ•°</th>
                            <th>å†…éƒ¨äº¤æ˜“</th>
                            <th>çµé­‚å‹‹ç« </th>
                            <th>äº¤äº’åˆçº¦</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // äº¤äº’ç®¡ç†åŠŸèƒ½ï¼ˆä¿æŒå®Œå…¨ä¸å˜ï¼‰
        let projects = JSON.parse(localStorage.getItem('projects')) || [];
        let openedProjects = JSON.parse(localStorage.getItem('openedProjects')) || [];
        // ... ä¿æŒåŸæœ‰äº¤äº’ç®¡ç†ä»£ç ä¸å˜ ...

        // æ›´æ–°åçš„é’±åŒ…æŸ¥è¯¢åŠŸèƒ½
        const SOUL_NFT_CONTRACT = '0x922dA3512e2BEBBe32bccE59adf7E6759fB8CEA2'.toLowerCase();
        const API_CONFIG = {
            tokens: 'https://api.blockvision.org/v2/monad/account/tokens',
            transactions: 'https://api.blockvision.org/v2/monad/account/transactions',
            internal: 'https://api.blockvision.org/v2/monad/account/internal/transactions'
        };

        class WalletAnalyzer {
            constructor() {
                this.totalMON = 0;
                this.totalAprMON = 0;
                this.contractCache = new Set();
            }

            async analyze(addresses, threads, interval) {
                const batchSize = parseInt(threads);
                const totalBatches = Math.ceil(addresses.length / batchSize);
                
                for (let i = 0; i < totalBatches; i++) {
                    const batch = addresses.slice(i * batchSize, (i + 1) * batchSize);
                    await Promise.all(batch.map(addr => this.processAddress(addr)));
                    if (i < totalBatches - 1) await this.delay(interval * 1000);
                }
            }

            async processAddress(address) {
                try {
                    const [tokens, txData] = await Promise.all([
                        this.fetchPaginatedTokens(address),
                        this.fetchTransactionData(address)
                    ]);

                    const monBalance = this.getBalance(tokens, '0x0000000000000000000000000000000000000000');
                    const aprMonBalance = this.getBalance(tokens, '0xb2f82D0f38dc453D596Ad40A37799446Cc89274A');
                    
                    const result = {
                        address,
                        monBalance,
                        aprMonBalance,
                        totalTx: txData.transactions.total,
                        internalTx: txData.internal.total,
                        hasSoulNFT: this.checkNFT(tokens),
                        contractCount: this.contractCache.size
                    };

                    this.updateGlobalStats(result);
                    this.appendToTable(result);
                } catch (error) {
                    console.error(`å¤„ç†åœ°å€ ${address} å¤±è´¥:`, error);
                }
            }

            async fetchPaginatedTokens(address) {
                let allTokens = [];
                let cursor = '';
                do {
                    const response = await fetch(`${API_CONFIG.tokens}?address=${address}&limit=50&cursor=${cursor}`);
                    const data = await response.json();
                    allTokens = allTokens.concat(data.result?.data || []);
                    cursor = data.result?.nextPageCursor || '';
                } while (cursor);
                return allTokens;
            }

            async fetchTransactionData(address) {
                const [transactions, internal] = await Promise.all([
                    this.fetchPaginated(`${API_CONFIG.transactions}?address=${address}&limit=50`),
                    this.fetchPaginated(`${API_CONFIG.internal}?address=${address}&limit=50`)
                ]);

                transactions.data.forEach(tx => {
                    if (tx.toAddress?.isContract) {
                        this.contractCache.add(tx.toAddress.address.toLowerCase());
                    }
                });

                return { transactions, internal };
            }

            async fetchPaginated(url) {
                let total = 0;
                let data = [];
                let cursor = '';
                do {
                    const response = await fetch(`${url}&cursor=${cursor}`);
                    const json = await response.json();
                    total = json.result?.total || 0;
                    data = data.concat(json.result?.data || []);
                    cursor = json.result?.nextPageCursor || '';
                } while (cursor);
                return { total, data };
            }

            getBalance(tokens, contract) {
                const token = tokens.find(t => 
                    t.contractAddress?.toLowerCase() === contract.toLowerCase()
                );
                return token ? Number(token.balance).toFixed(4) : '0.0000';
            }

            checkNFT(tokens) {
                return tokens.some(t => 
                    t.contractAddress?.toLowerCase() === SOUL_NFT_CONTRACT
                ) ? 'âœ…' : 'âŒ';
            }

            updateGlobalStats(result) {
                this.totalMON += parseFloat(result.monBalance);
                this.totalAprMON += parseFloat(result.aprMonBalance);
                
                document.getElementById('totalMON').textContent = this.totalMON.toFixed(4);
                document.getElementById('totalAprMON').textContent = this.totalAprMON.toFixed(4);
            }

            appendToTable(result) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${document.querySelectorAll('#resultBody tr').length + 1}</td>
                    <td>
                        <a href="https://testnet.monadexplorer.com/address/${result.address}" 
                           target="_blank">${result.address.slice(0, 8)}...${result.address.slice(-4)}
                        </a>
                    </td>
                    <td>${result.monBalance}</td>
                    <td>${result.aprMonBalance}</td>
                    <td>${result.totalTx}</td>
                    <td>${result.internalTx}</td>
                    <td>${result.hasSoulNFT}</td>
                    <td>${result.contractCount}</td>
                `;
                document.getElementById('resultBody').appendChild(row);
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        async function startAnalysis() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const addresses = document.getElementById('addresses').value
                .split('\n')
                .map(a => a.trim())
                .filter(a => /^0x[a-fA-F0-9]{40}$/.test(a));

            if (!apiKey) return alert('è¯·è¾“å…¥APIå¯†é’¥');
            if (addresses.length === 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆåœ°å€');

            document.getElementById('resultBody').innerHTML = '';
            
            const analyzer = new WalletAnalyzer();
            await analyzer.analyze(
                addresses,
                document.getElementById('threads').value,
                document.getElementById('interval').value
            );
        }

        // åˆå§‹åŒ–å¯¼èˆªåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            // ä¿æŒåŸæœ‰å¯¼èˆªé€»è¾‘ä¸å˜...
        });
    </script>
</body>
</html>
